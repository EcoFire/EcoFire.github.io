<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Justin Ziegler" />

<meta name="date" content="2018-10-15" />

<title>Forest typing with Stem-maps in R</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>




<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 45px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 50px;
  margin-top: -50px;
}

.section h2 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h3 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h4 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h5 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h6 {
  padding-top: 50px;
  margin-top: -50px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->





<!-- favicon -->
<link rel="icon" type="img/png" href="site_content/img/rbmv_fav.png" />

<!-- fonts -->
<!-- <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700|Roboto+Mono:100i,300,700,700i|Roboto:100,100i,300,300i" rel="stylesheet">
-->
<!-- navbar -->
<div class="navbar navbar-default  navbar-fixed-top no-print" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">
        <img alt="Brand" src="site_content/img/rbmv_curve.png" id="rbmv">
      </a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html" onclick="fadeInOut()">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="blog.html" onclick="fadeInOut()">
    <span class="fa fa-pencil-square-o"></span>
     
    Blog
  </a>
</li>
<li>
  <a href="research.html" onclick="fadeInOut()">
    <span class="fa fa-comments-o"></span>
     
    Research
  </a>
</li>
<li>
  <a href="index.html#about" onclick="fadeInOut()">
    <span class="fa fa-newspaper-o"></span>
     
    About
  </a>
</li>
<li>
  <a href="mailto:Justin.Ziegler@Colostate.edu">
    <span class="fa fa-send-o"></span>
     
    Connect
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Forest typing with Stem-maps in R</h1>
<h4 class="author"><em>Justin Ziegler</em></h4>
<h4 class="date"><em>October 15, 2018</em></h4>

</div>


<p><br></p>
<blockquote>
<p>A few years ago, Kaggle held a competition to predict forest cover types using machine learning techniques. The data, taken from the Arapaho-Roosevelt National Forest here in Colorado and provided by the UCI Machine Learning Repository, contained a stack of rasters such as elevation, aspect, hillshade, distance to past fires, roads, and waterways. Competitors are supposed to use a subset of the current typology of forest cover to build and train machine learning algorithms which are then applied to a test set of forest cover types. This process works great for purposes such as forest planning or landscape ecology studies where 30-m resolution is sufficient.</p>
</blockquote>
<blockquote>
<p>But what if the ecological relationship of interest occurs at a much finer resolution and one would like to relate within-plot variability of some measure to an overstory-based typology. This post dives into using Spatstat to transform point-based observations to two-dimensional surfaces with categorical values.</p>
</blockquote>
<p>For this exercise, we will look at stem-map data used in Ziegler et al. (2017). In these stem-maps, I measured the locations and species of trees in seven 4-ha plots in Colorado, New Mexico, and Arizona. The data we will use comes from a single plot just outside of Red Feather Lake, Colorado which you can download in the link below. We will work with these data in R.</p>
<p>install.packages(‘spatstat’) #Download if you do not have</p>
<p>library(spatstat) trees = read.table(url(‘<a href="https://dl.dropboxusercontent.com/s/35lqyl5ly0qmq9h/redfeather.txt?dl=0" class="uri">https://dl.dropboxusercontent.com/s/35lqyl5ly0qmq9h/redfeather.txt?dl=0</a>’), header=T)</p>
<p>Now let’s create a ppp data type so that Spatstat can work with the data. We will also attribute marks to these points using 4-letter species codes.</p>
<p>treemap = ppp(trees<span class="math inline">\(x_m, trees\)</span>y_m, c(0,200), c(0,200), unitname=c(“meter”,“meter”), marks = trees$species) plot(split(treemap),pch=19,cex=0.2)</p>
<p>The map split by species shows that quaking aspen (POTR) and Douglas-fir (PSME) are concentrated in a subset of the plot while ponderosa pine (PIPO) are almost everywhere.</p>
<p>So we can already guess what forest types ought to appear from our analysis. To assign cover types, we will use the relrisk function. This function uses a kernel smoother to estimate a surface of likelihood of species occurrence using species’ point densities. In this example, we will define the kernel’s bandwidth and stipulate the resolution of the output image.</p>
<p>speciesrisk = relrisk(treemap, sigma=2, dimyx = 50) plot(speciesrisk) covermap = im.apply(speciesrisk, which.max) cover = levels(marks(treemap)) covermap = eval.im(cover[covermap]) plot(covermap, main=“Cover type”)</p>
<p>Overall, the results show that there are patches of quaking aspen and Douglas-fir in a sea of ponderosa pine.</p>
<br>
<hr>
<p><br></p>
<p>In the next step, we will further disaggregate cover types by size classes. For illustration, we will assume regeneration are those trees with diameter at breast height (dbh) less than 5 cm, mature trees have a dbh over 13 cm, and saplings are between the breakpoints. Here we will use ggplot2’s (superior) plotting. Notice that in this example I used a wider bandwidth (sigma = 6) to gloss over fine-scale detail.</p>
<p>install.packages(‘ggplot2’) library(ggplot2) trees<span class="math inline">\(sizeclass = &#39;sapling&#39; trees\)</span>sizeclass[trees$dbh_cm&lt;5] = ‘regen’ trees<span class="math inline">\(sizeclass[trees\)</span>dbh_cm&gt;13] = ‘tree’ trees<span class="math inline">\(sizecoverclass = paste(trees\)</span>species,trees$sizeclass)</p>
<p>marks(treemap) = as.factor(trees$sizecoverclass)</p>
<p>classrisk = relrisk(treemap,sigma=6,dimyx=50) covermap &lt;- im.apply(classrisk, which.max) cover &lt;- levels(marks(treemap)) covermap &lt;- as.data.frame(eval.im(cover[covermap]))</p>
<p>cols &lt;- c(‘PIPO regen’ =‘#a50026’, ‘PIPO sapling’=‘#d73027’, ‘PIPO tree’=‘#f46d43’, ‘POTR regen’=‘#006837’, ‘POTR sapling’=‘#1a9850’, ‘POTR tree’=‘#66bd63’, ‘PSME sapling’=‘#d9ef8b’, ‘PSME tree’=‘#ffffbf’)</p>
<p>ggplot(covermap,aes(x,y,fill=value))+geom_raster()+ scale_fill_manual(values = cols) + theme_classic()</p>
<p>In this analysis, we see that most of the plot consists of ponderosa pine trees, but patches of seedlings and regeneration do exist. We can also note that most quaking aspen occur in regeneration patches.</p>
<br>
<hr>
<p><br></p>
<p>One thing an ecologist might note is that larger trees might have a larger influence on their immediate environment than smaller trees. If so, it makes sense to weight the typology by tree size. Here we will use local basal area to determine which species are dominant.</p>
<p>trees<span class="math inline">\(BA = trees\)</span>dbh_cm^2*.00007854 PIPOmap = with(trees[trees$species==‘PIPO’,], ppp(x_m, y_m, c(0, 200), c(0, 200), marks=BA)) POTRmap = with(trees[trees$species==‘POTR’,], ppp(x_m, y_m, c(0, 200), c(0, 200), marks=BA)) PSMEmap = with(trees[trees$species==‘PSME’,], ppp(x_m, y_m, c(0, 200), c(0, 200), marks=BA))</p>
<p>CoverbyBA = im.apply(list( Smooth(PIPOmap, 6, dimyx=50), Smooth(POTRmap, 6, dimyx=50), Smooth(PSMEmap, 6, dimyx=50)), which.max)</p>
<p>plot(eval.im(c(‘PIPO’,‘POTR’,‘PSME’)[CoverbyBA]))</p>
<p>Woah! This doesn’t look right. Douglas-fir shouldn’t be the dominant cover type in half the plot. The way the Smooth function works is that takes the marks of trees where the trees exist and then interpolates everywhere else. So it naturally can take a few large Douglas-fir trees and smoothes those data points over the whole plot. So here smoothing doesn’t account for that fact that areas without Douglas-fir trees inherently have no Douglas-fir basal area. One workaround would be weigh tree basal area by tree density. So now we will use the density function which is a way to interpolate tree density based on the spatially-varying frequency of mapped trees.</p>
<p>CoverbyBA = im.apply(list( Smooth(PIPOmap, 6, dimyx=50) * density(PIPOmap, 6, dimyx=50), Smooth(POTRmap, 6, dimyx=50) * density(POTRmap, 6, dimyx=50), Smooth(PSMEmap, 6, dimyx=50) * density(PSMEmap, 6, dimyx=50)), which.max)</p>
<p>plot(eval.im(c(‘PIPO’,‘POTR’,‘PSME’)[CoverbyBA]))</p>
<p>Now this is better. It emphasizes the spatial dominance of ponderosa pine more so than our first typology. There is much less space assigned to quaking aspen in particular. That’s because, according to our second typology, many patches of quaking aspen were just regeneration so they contributed less basal area than surrounding ponderosa pine.</p>
<br>
<hr>
<p><br></p>
<p>What do you think? Can this approach be useful for categorizing intra-plot variation in your research? I’d like to hear your thoughts on using point-based spatial locations of trees, or any other discrete spatial events for that matter, to create raster images.</p>
<iframe width="100%" height="300" src="https://rdrr.io/snippets/embed/?code=print(%22wth%2C%20world!%22)" frameborder="0">
</iframe>

  </div> <!-- articleBandContent -->
</div> <!-- pageContent -->

<footer class="no-print">
  <div id="rbmvFooter" class="footer">
    <div class="footerContent">
    
      <!-- column 1 -->
      <div class="col-md-4">
        <p><i class="fa fa-send fa-lg"></i> Connect with me<br>
        <a href="mailto:Justin.Zieger@Colostate.edu">Justin.Zieger@Colostate.edu</a>
        <br>
        <br>
      </div>

      <!-- column 2 -->
      <div class="col-md-4">
        <a href="https://github.com/EcoFire">
          <i class="fa fa-github fa-lg"></i> EcoFire GitHub</a>
        <a href="https://www.linkedin.com/in/justin-p-ziegler-b5230466/">
          <br>
          <i class="fa fa-linkedin fa-lg"></i> My LinkedIn</a>
		<a href="https://github.com/EcoFire">
		<br>
          <i class="fas fa-graduation-cap"></i> My Google Scholar</a>
        <br>
        <br>
      </div>

      <!-- column 3 -->
      <div class="col-md-4">
        <p class="text">I am a research associate and doctoral student studying spatial forest and fire dynamics. EcoFire is my platform to discuss ideas and methods behind the science. Thanks for visiting!</p>
        <br>
        <br>
      </div>
      <div class="top">
        <p class="pull-right">
          <a id="scrollTop" class="slowly" onclick="slowScrollTop()" href=#>
            <i class="fa fa-angle-double-up"></i> Back to top
          </a>
        </p>
      </div>
    </div>
  </div>
  
  <!-- slow scrollTop function -->
  <script type="text/javascript">
    function slowScrollTop() { 
      $('body').animate({ scrollTop: 0 }, 'slow'); 
    } 
  </script>
  
  <!-- page transition -->
  <script type="text/javascript">
    // fade content and not navbar in and out
    $(document).ready(function fadeInOut() {
      var non_navbar = $('.fluid-row,.section.level2,.summary,p,acrticle,h3,footer')
      non_navbar.css('display', 'none');
      non_navbar.fadeIn(800);
    
      $('.navbar-link').click(function(event) {
        event.preventDefault();
        newLocation = this.href;
      
        non_navbar.fadeOut('slow', newpage);
      });
    
      function newpage() {
        window.location = newLocation;
      }
    });
  </script>
  
  <!-- google analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83611715-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</footer>

<!-- disqus -->
<script id="dsq-count-scr" src="//rbmv.disqus.com/count.js" async></script>
<div id="disqus_thread" class="disqusPadding"></div>
  <script>
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = '//rbmv.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
