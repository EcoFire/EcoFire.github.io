<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Justin Ziegler" />

<meta name="date" content="2018-10-15" />

<title>Scraping weather data with R</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 45px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 50px;
  margin-top: -50px;
}

.section h2 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h3 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h4 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h5 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h6 {
  padding-top: 50px;
  margin-top: -50px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->





<!-- favicon -->
<link rel="icon" type="img/png" href="site_content/img/rbmv_fav.png" />

<!-- fonts -->
<!-- <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700|Roboto+Mono:100i,300,700,700i|Roboto:100,100i,300,300i" rel="stylesheet">
-->
<!-- navbar -->
<div class="navbar navbar-default  navbar-fixed-top no-print" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">
        <img alt="Brand" src="site_content/img/rbmv_curve.png" id="rbmv">
      </a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html" onclick="fadeInOut()">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="blog.html" onclick="fadeInOut()">
    <span class="fa fa-pencil-square-o"></span>
     
    Blog
  </a>
</li>
<li>
  <a href="research.html" onclick="fadeInOut()">
    <span class="fa fa-newspaper-o"></span>
     
    Research
  </a>
</li>
<li>
  <a href="index.html#about" onclick="fadeInOut()">
    <span class="fa fa-user-circle-o"></span>
     
    About
  </a>
</li>
<li>
  <a href="mailto:Justin.Ziegler@Colostate.edu">
    <span class="fa fa-send-o"></span>
     
    Connect
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Scraping weather data with R</h1>
<h4 class="author"><em>Justin Ziegler</em></h4>
<h4 class="date"><em>October 15, 2018</em></h4>

</div>


<p><br></p>
<blockquote>
<p>In the past year, the ideal source for historic, real-time, and forecasted weather data migrated from a free API to a subscription service. This source that shall not be named, strung together different networks of public and prive weather stations, stringing together a dense mesonet. Mesonets are awesome because they allow esearchers to knit observations for wall-to-wall coverage. The agony that this API has been phased out!<br />
For me, weather is a key input in many functions in my package, <a href="https://github.com/EcoFire/firebehavioR"><code>firebehavior</code></a>. And because of the influence that weather has on fire behavior, the ability to scrape weather from online sources extends my package’s capability (not to mention all of the other research fields that draw on meteorology!). So where can one go to for reliable weather data downloads using a simple process? In what may become a series of posts, I will explore exporing various sources to create a patchwork mesonet.</p>
</blockquote>
<blockquote>
<p>In this article, we will dive into two simple-to-get sources of weather in the US. I call these simple because there is no API authentication to jump through, just structured data files sitting on html pages waiting to be downloaded. Of course, that convenience comes with downsides which will be discussed.</p>
</blockquote>
<div id="working-with-raws-data" class="section level3">
<h3>Working with RAWS data</h3>
<p>RAWS, or remote automated weather stations, are a collected on (remote, obviously) stations maintained by state and federal land manager agencies, mostly for real-time monitoring of wildfire hazard. RAWS are data are available from certain sources like MesoWest but, as far as I know, automated scraping or bulk download of real-time data is not permissible. So <strong>that</strong> is a big downside, and a significant one at that. However, backwards looking weather analyses still have significant potential for research so let’s get on with it.</p>
<p>So I decided to wite a nice little function that is fairly flexible for queries. In <code>getRAWS</code>, you can enter in only the state or county, or you can set a year range, have four coordinates as a bounding box, and also filter by elevation. By default it will create a folder called <code>/raws</code> under your working directory. As far as I can tell CRAN are not huge supporters of functions that mess with your directory structure so it’s worth noting that Personally I wrote this as a download-the-data function because it’s nice to have to query the website only once.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">getRAWS &lt;-<span class="st"> </span><span class="cf">function</span>(state, county, yearrange, <span class="dt">coords =</span> <span class="ot">NULL</span>, <span class="dt">elev =</span> <span class="ot">NULL</span>, <span class="dt">path =</span> <span class="st">&quot;./raws&quot;</span>) {
  rawsSubset =<span class="st"> </span>rawsMetadata

  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(state)) {
    rawsSubset &lt;-<span class="st"> </span>rawsSubset[rawsSubset<span class="op">$</span>state <span class="op">==</span><span class="st"> </span>state, ]
  }
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(county)) {
    rawsSubset &lt;-<span class="st"> </span>rawsSubset[rawsSubset<span class="op">$</span>county <span class="op">==</span><span class="st"> </span>county, ]
  }
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(coords)) {
    rawsSubset &lt;-<span class="st"> </span>rawsSubset[
      rawsSubset<span class="op">$</span>latdeg <span class="op">&gt;=</span><span class="st"> </span>coords[<span class="dv">1</span>] <span class="op">&amp;</span>
<span class="st">        </span>rawsSubset<span class="op">$</span>latdeg <span class="op">&lt;=</span><span class="st"> </span>coords[<span class="dv">2</span>] <span class="op">&amp;</span>
<span class="st">        </span>rawsSubset<span class="op">$</span>longdeg <span class="op">&gt;=</span><span class="st"> </span>coords[<span class="dv">3</span>] <span class="op">&amp;</span>
<span class="st">        </span>rawsSubset<span class="op">$</span>longdeg <span class="op">&lt;=</span><span class="st"> </span>coords[<span class="dv">4</span>],
    ]
  }
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(elev)) {
    rawsSubset &lt;-<span class="st"> </span>rawsSubset[rawsSubset<span class="op">$</span>elev <span class="op">&gt;=</span><span class="st"> </span>elev[<span class="dv">1</span>] <span class="op">&amp;</span>
<span class="st">      </span>rawsSubset<span class="op">$</span>elev <span class="op">&lt;=</span><span class="st"> </span>elev[<span class="dv">2</span>], ]
  }

  <span class="kw">print</span>(<span class="kw">paste</span>(<span class="kw">dim</span>(rawsSubset)[<span class="dv">1</span>],<span class="st">&#39;RAWS found. Downloading RAWS data.&#39;</span>))

  <span class="kw">dir.create</span>(path, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)

  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">dim</span>(rawsSubset)[<span class="dv">1</span>]){
  counter =<span class="st"> </span>i
  url =<span class="st"> </span><span class="kw">paste</span>(<span class="st">&#39;https://fam.nwcg.gov/fam-web/weatherfirecd/data/&#39;</span>,<span class="kw">tolower</span>(rawsSubset<span class="op">$</span>state[i]),<span class="st">&#39;/wx&#39;</span>,rawsSubset<span class="op">$</span>station[i],<span class="st">&#39;.fw13&#39;</span>,<span class="dt">sep=</span><span class="st">&#39;&#39;</span>)
  file =<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">url</span>(url),<span class="dt">header=</span>F)

  <span class="cf">if</span> (counter <span class="op">%%</span><span class="st"> </span><span class="dv">10</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">print</span>(<span class="kw">paste</span>(counter, <span class="st">&quot;annual records attempted to download.&quot;</span>))
    }
  <span class="kw">print</span>(<span class="kw">paste</span>(<span class="kw">length</span>(<span class="kw">list.files</span>(<span class="dt">path =</span> path, <span class="dt">pattern =</span> <span class="st">&quot;.fw13&quot;</span>)), <span class="st">&quot;annual records successfully downloaded. Proceeding to process&quot;</span>))


  }</code></pre></div>
<p>If you noticed, this function depends on <code>rawsMetadata</code>. Let’s take a look at that real quick..</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&#39;site_content/data/rawsMetadata.rda&#39;</span>)
<span class="kw">head</span>(rawsMetadata)</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
state
</th>
<th style="text-align:left;">
county
</th>
<th style="text-align:left;">
station
</th>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
elev
</th>
<th style="text-align:right;">
aspect
</th>
<th style="text-align:right;">
annPrecip
</th>
<th style="text-align:right;">
latdeg
</th>
<th style="text-align:right;">
longdeg
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
AK
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
500101
</td>
<td style="text-align:left;">
GALBRAITH
</td>
<td style="text-align:right;">
2661
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5.39
</td>
<td style="text-align:right;">
68.48333
</td>
<td style="text-align:right;">
-149.4833
</td>
</tr>
<tr>
<td style="text-align:left;">
AK
</td>
<td style="text-align:left;">
Northwest Arctic
</td>
<td style="text-align:left;">
500102
</td>
<td style="text-align:left;">
NOATAK
</td>
<td style="text-align:right;">
985
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
8.00
</td>
<td style="text-align:right;">
68.07083
</td>
<td style="text-align:right;">
-158.7042
</td>
</tr>
<tr>
<td style="text-align:left;">
AK
</td>
<td style="text-align:left;">
North Slope
</td>
<td style="text-align:left;">
500103
</td>
<td style="text-align:left;">
BARROW_(BRW93)
</td>
<td style="text-align:right;">
44
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
7.20
</td>
<td style="text-align:right;">
71.28556
</td>
<td style="text-align:right;">
-156.7661
</td>
</tr>
<tr>
<td style="text-align:left;">
AK
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
500104
</td>
<td style="text-align:left;">
UMIAT
</td>
<td style="text-align:right;">
289
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
10.00
</td>
<td style="text-align:right;">
69.37250
</td>
<td style="text-align:right;">
-152.1356
</td>
</tr>
<tr>
<td style="text-align:left;">
AK
</td>
<td style="text-align:left;">
Nome
</td>
<td style="text-align:left;">
500203
</td>
<td style="text-align:left;">
UNALAKLEET_(UNK)
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
14.58
</td>
<td style="text-align:right;">
63.88806
</td>
<td style="text-align:right;">
-160.7986
</td>
</tr>
<tr>
<td style="text-align:left;">
AK
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
500204
</td>
<td style="text-align:left;">
KIANA
</td>
<td style="text-align:right;">
150
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
8.00
</td>
<td style="text-align:right;">
66.98333
</td>
<td style="text-align:right;">
-160.4333
</td>
</tr>
</tbody>
</table>
<hr>
<p>What do you think? Can this approach be useful for categorizing intra-plot variation in your research? I’d like to hear your thoughts on using point-based spatial locations of trees, or any other discrete spatial events for that matter, to create raster images.</p>
</div>

  </div> <!-- articleBandContent -->
</div> <!-- pageContent -->

<footer class="no-print">
  <div id="rbmvFooter" class="footer">
    <div class="footerContent">
    
      <!-- column 1 -->
      <div class="col-md-4">
        <p><i class="fa fa-send fa-lg"></i> Connect with me<br>
        <a href="mailto:Justin.Zieger@Colostate.edu">Justin.Zieger@Colostate.edu</a>
        <br>
        <br>
      </div>

      <!-- column 2 -->
      <div class="col-md-4">
        <a href="https://github.com/EcoFire">
          <i class="fa fa-github fa-lg"></i> EcoFire GitHub</a>
        <a href="https://www.linkedin.com/in/justin-p-ziegler-b5230466/">
          <br>
          <i class="fa fa-linkedin fa-lg"></i> My LinkedIn</a>
		<a href="https://github.com/EcoFire">
		<br>
          <i class="fas fa-graduation-cap"></i> My Google Scholar</a>
        <br>
        <br>
      </div>

      <!-- column 3 -->
      <div class="col-md-4">
        <p class="text">I am a research associate and doctoral student studying spatial forest and fire dynamics. EcoFire is my platform to discuss ideas and methods behind the science. Thanks for visiting!</p>
        <br>
        <br>
      </div>
      <div class="top">
        <p class="pull-right">
          <a id="scrollTop" class="slowly" onclick="slowScrollTop()" href=#>
            <i class="fa fa-angle-double-up"></i> Back to top
          </a>
        </p>
      </div>
    </div>
  </div>
  
  <!-- slow scrollTop function -->
  <script type="text/javascript">
    function slowScrollTop() { 
      $('body').animate({ scrollTop: 0 }, 'slow'); 
    } 
  </script>
  
  <!-- page transition -->
  <script type="text/javascript">
    // fade content and not navbar in and out
    $(document).ready(function fadeInOut() {
      var non_navbar = $('.fluid-row,.section.level2,.summary,p,acrticle,h3,footer')
      non_navbar.css('display', 'none');
      non_navbar.fadeIn(800);
    
      $('.navbar-link').click(function(event) {
        event.preventDefault();
        newLocation = this.href;
      
        non_navbar.fadeOut('slow', newpage);
      });
    
      function newpage() {
        window.location = newLocation;
      }
    });
  </script>
  
  <!-- google analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83611715-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</footer>

<!-- disqus -->
<script id="dsq-count-scr" src="//rbmv.disqus.com/count.js" async></script>
<div id="disqus_thread" class="disqusPadding"></div>
  <script>
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = '//rbmv.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
